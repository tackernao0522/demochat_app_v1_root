version: 2.1

orbs:
  ruby: circleci/ruby@1.6

jobs:
  build:
    docker:
      - image: cimg/ruby:3.1
      - image: circleci/postgres:15.1
        environment:
          POSTGRES_USER: postgres
          POSTGRES_DB: app_test
    steps:
      - checkout

      - run:
          name: Initialize Submodules
          command: |
            git submodule sync
            git submodule update --init

      - ruby/install-deps

      - run:
          name: Setup Environment Variables
          command: |
            echo 'export POSTGRES_PASSWORD=postgres' >> $BASH_ENV

      - run:
          name: Database setup
          command: |
            bundle exec rails db:create
            bundle exec rails db:schema:load
            bundle exec rails db:migrate

      - run:
          name: Run tests
          command: bundle exec rspec

workflows:
  version: 2
  build:
    jobs:
      - build
