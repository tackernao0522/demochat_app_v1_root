version: 2.1

jobs:
  setup:
    docker:
      - image: circleci/ruby:3.3.2
    steps:
      - checkout
      - run:
          name: Initialize and Update Submodules
          command: |
            git submodule init
            git submodule update
      - run:
          name: Install Dependencies
          command: |
            cd demochat_app_v1_api
            bundle install

  test_api:
    docker:
      - image: circleci/ruby:3.3.2
    steps:
      - checkout
      - run:
          name: Initialize and Update Submodules
          command: |
            git submodule init
            git submodule update
      - run:
          name: Run API Tests
          command: |
            cd demochat_app_v1_api
            bundle exec rspec

  build_front:
    docker:
      - image: circleci/node:14
    steps:
      - checkout
      - run:
          name: Initialize and Update Submodules
          command: |
            git submodule init
            git submodule update
      - run:
          name: Install Frontend Dependencies
          command: |
            cd demochat_app_v1_front
            npm install
      - run:
          name: Build Frontend
          command: |
            cd demochat_app_v1_front
            npm run build

workflows:
  version: 2
  build_and_test:
    jobs:
      - setup
      - test_api:
          requires:
            - setup
      - build_front:
          requires:
            - setup
